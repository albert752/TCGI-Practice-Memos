<!--
To include in cheatsheet
-->

# Practice 7 memo of TCGI
## Exercice 1
### Section 1
After running the default configuration command we can see that the
configuration of the mentioned hosts we configure the filtering tables of
`host1`. The rules are:

* Block all entering `ICMP` traffic.

We run on `host1`: `iptables -t filter -A INPUT -p ICMP -j DROP`

And now we test the configuration by _pinging_ the `host1` from `Rint`. 
* We can capture the `echo-request` generated by `Rint`.
* We can't not capture the `echo-reply` because the `echo-request` packet gets droped when it
	arrives.
* It gets silently droped

Now we perform the reverse operation.
* We can capture both the `echo-request` and the `echo-reply` but the `host1`
	reports that the package has been lost.
* The cause of this behaviour is the filter. The package is received but
	silently drop and never gets served to the application.

### Section 2
The next step is to remove the before aplied filter by running: `iptables -t filter -D INPUT -p ICMP -j DROP`
And we test the configiration with a simple ping. It's time to cnfigure by:
* The `host1` must be able to ping `Rint`.
* The `host1` must no reply any ping request.

In order to configure this set-up we run: `iptables -t filter -A INPUT -p ICMP --icmp-type echo-request -j DROP`.
* When `host1` pings `Rint` we see the normal behaviour.
* When `Rint` pings `hosts` we see the same procedure than before when all ICMP
	packets where droped.

### Section 3
Now we configure the `Rint` router as the _network guard_. We first delete all
entries of the filtering tables of `host1` by running `iptables -t filter -D INPUT -p ICMP --icmp-type echo-request -j DROP`.
After checking the connection with `Net1` via ping ping we can proceed by
setting up the requested escenario with the following commands:

```
Rint:~# iptables -t filter -A FORWARD -p ICMP -s 192.168.1.0/24 --icmp-type echo-request -j ACCEPT
Rint:~# iptables -t filter -A FORWARD -p ICMP --icmp-type echo-request -j DROP
```

Now the ping from `host1` to `www` works but not vice-versa.

In order to setup the `TCP` filtering, we run the following commands:

```
Rint:~# iptables -t filter -A FORWARD -s 192.168.1.0/24 -p tcp --syn -j ACCEPT
Rint:~# iptables -t filter -A FORWARD -p tcp --syn -j DROP
```
Now try a `nc` from `host1` to `www` and it works but not vice-versa.

The last configuration is the `UDP`, we add:

```
-A FORWARD -s 172.16.1.5/32 -p udp -j ACCEPT
-A FORWARD -d 172.16.1.5/32 -p udp -j ACCEPT
-A FORWARD -p udp -j DROP
```

We try this configuration with the command `dig dns.practnet.tcgi`

This is the final configuration file:

```
Rint:~# cat tables.txt
# Generated by iptables-save v1.4.2 on Sun Apr 28 16:11:18 2019
*filter
:INPUT ACCEPT [4:514]
:FORWARD ACCEPT [5:396]
:OUTPUT ACCEPT [4:278]
-A FORWARD -s 192.168.1.0/24 -p tcp -m tcp --tcp-flags FIN,SYN,RST,ACK SYN -j ACCEPT
-A FORWARD -p tcp -m tcp --tcp-flags FIN,SYN,RST,ACK SYN -j DROP

-A FORWARD -s 192.168.1.0/24 -p icmp -m icmp --icmp-type 8 -j ACCEPT
-A FORWARD -p icmp -m icmp --icmp-type 8 -j DROP

-A FORWARD -s 172.16.1.5/32 -p udp -j ACCEPT
-A FORWARD -d 172.16.1.5/32 -p udp -j ACCEPT
-A FORWARD -p udp -j DROP
COMMIT
# Completed on Sun Apr 28 16:11:18 2019
```

## Exercice 2
The first step is to try to ping the `test` machine from `www`. If we capter
the traffic on `SimNet0` we can see that the destiation @IP is correct but the
source @IP is private, not 'public'. So this is why we do not receive any
reply.

After running `Rbcn:~# iptables -t nat -A POSTROUTING -o eth2 -j SNAT --to
10.0.2.2`, the pting command works like a charm.

Now we want to give `test` acces to the `Net1`. If we run the `ping` from
`test` we get the `Network unreachable` error. In order to be able to acces
the net, we run `Rbcn:~# iptables -t nat -A PREROUTING -p tcp
--destination-port 80 -j DNAT --to 172.16.1.2`

